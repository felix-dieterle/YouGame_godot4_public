name: Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Godot
      uses: chickensoft-games/setup-godot@v1
      with:
        version: 4.3.0
        use-dotnet: false
    
    - name: Verify project structure
      run: |
        echo "Checking project structure..."
        ls -la
        cat project.godot
    
    - name: Run tests
      run: |
        echo "Running Godot tests..."
        godot --headless --path . res://tests/test_scene.tscn

  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    needs: test
    
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Godot
      uses: chickensoft-games/setup-godot@v1
      with:
        version: 4.3.0
        use-dotnet: false
        include-templates: true
    
    - name: Create export directory
      run: mkdir -p export
    
    - name: Build APK
      run: |
        echo "Building Android APK..."
        echo "Using debug export with automatic debug keystore signing"
        godot --headless --export-debug "Android" export/YouGame.apk || { echo "Godot export failed"; exit 1; }
        
        # Verify the APK was created
        if [ -f export/YouGame.apk ]; then
          echo "APK created successfully!"
          ls -lh export/YouGame.apk
        else
          echo "Error: APK was not created"
          exit 1
        fi
    
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: YouGame-APK
        path: export/*.apk
        if-no-files-found: warn
