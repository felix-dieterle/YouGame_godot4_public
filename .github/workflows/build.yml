name: Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write  # Changed to write to allow creating releases and tags

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Godot
      uses: chickensoft-games/setup-godot@v1
      with:
        version: 4.3.0
        use-dotnet: false
    
    - name: Verify project structure
      run: |
        echo "Checking project structure..."
        ls -la
        cat project.godot
    
    - name: Validate scripts (check for parse errors)
      run: |
        echo "Validating GDScript files for parse errors..."
        godot --headless --path . --check-only --quit 2>&1 | tee script_validation.log
        if grep -qi "SCRIPT ERROR:\|Parse Error:\|PARSE ERROR:\|Failed to load script" script_validation.log; then
          echo "❌ Script validation failed - parse errors detected"
          grep -i "SCRIPT ERROR:\|Parse Error:\|PARSE ERROR:\|Failed to load script" script_validation.log
          exit 1
        else
          echo "✅ All scripts validated successfully"
        fi
    
    - name: Run tests with timeout monitoring
      timeout-minutes: 10
      run: |
        echo "Running test suite with individual test timeouts..."
        chmod +x tests/run_tests.sh
        ./tests/run_tests.sh
    
    - name: Upload test screenshots
      uses: actions/upload-artifact@v4
      if: always()  # Upload screenshots even if tests fail
      with:
        name: test-screenshots
        path: test_screenshots/*.png
        if-no-files-found: ignore

  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    needs: test
    
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Godot
      uses: chickensoft-games/setup-godot@v1
      with:
        version: 4.3.0
        use-dotnet: false
        include-templates: true
    
    - name: Install Android Build Template
      run: |
        echo "Installing Android build template for widget builds..."
        
        # Debug: Show where templates are installed
        echo "Checking for Godot templates..."
        find ~/.local/share/godot -name "android_source.zip" 2>/dev/null || echo "No android_source.zip found in ~/.local/share/godot"
        
        # Run the install script
        chmod +x ./install_android_build_template.sh
        if ./install_android_build_template.sh; then
          echo "✓ Android build template installed successfully"
        else
          echo "⚠️ Failed to install Android build template automatically"
          echo "Widget APK build may fail"
          
          # Show template directory structure for debugging
          echo "Template directory contents:"
          ls -la ~/.local/share/godot/ 2>/dev/null || echo "No templates directory found"
          ls -la ~/.local/share/godot/export_templates/ 2>/dev/null || echo "No export_templates subdirectory"
        fi
    
    - name: Create export directory
      run: mkdir -p export
    
    - name: Build Standard APK
      run: |
        echo "Building Standard Android APK (without widget)..."
        echo "Using debug export with automatic debug keystore signing"
        godot --headless --export-debug "Android" export/YouGame.apk || { echo "Godot export failed"; exit 1; }
        
        # Verify the APK was created
        if [ -f export/YouGame.apk ]; then
          echo "Standard APK created successfully!"
          ls -lh export/YouGame.apk
        else
          echo "Error: Standard APK was not created"
          exit 1
        fi
    
    - name: Build Widget APK  
      continue-on-error: true
      id: widget_build
      run: |
        echo "Building Widget-enabled Android APK..."
        echo "Using debug export with automatic debug keystore signing"
        godot --headless --export-debug "Android Widget" export/YouGame-Widget.apk
        
        # Check if APK was created
        if [ -f export/YouGame-Widget.apk ]; then
          echo "Widget APK created successfully!"
          ls -lh export/YouGame-Widget.apk
          echo "success=true" >> $GITHUB_OUTPUT
        else
          echo "Widget APK was not created"
          echo "success=false" >> $GITHUB_OUTPUT
          exit 1
        fi
    
    - name: Report Widget Build Status
      if: steps.widget_build.outcome == 'failure'
      run: |
        echo "⚠️ Widget APK build failed"
        echo "This may be due to missing Android build template"
        echo "Only the standard APK will be available for this build"
    
    - name: Upload APK artifacts
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: YouGame-APKs
        path: export/*.apk
        if-no-files-found: warn

  release:
    name: Create Release on Merge
    runs-on: ubuntu-latest
    needs: build-android
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for tags
    
    - name: Get latest tag and bump version
      id: version
      run: |
        # Get the latest tag, or start with v1.0.0 if no tags exist
        git fetch --tags
        LATEST_TAG=$(git tag -l "v*" | sort -V | tail -n 1)
        
        if [ -z "$LATEST_TAG" ]; then
          # No tags exist, start with v1.0.0
          NEW_VERSION="v1.0.0"
        else
          # Extract version numbers
          VERSION=${LATEST_TAG#v}
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
          
          # Bump patch version
          PATCH=$((PATCH + 1))
          NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}"
        fi
        
        echo "new_version=${NEW_VERSION}" >> $GITHUB_OUTPUT
        echo "New version will be: ${NEW_VERSION}"
    
    - name: Update export_presets.cfg with new version
      run: |
        VERSION_NUMBER="${{ steps.version.outputs.new_version }}"
        VERSION_NUMBER=${VERSION_NUMBER#v}  # Remove 'v' prefix
        
        # Update version/name in export_presets.cfg for both presets
        # Use awk to update all version/name occurrences
        awk -v new_ver="$VERSION_NUMBER" '
          /^version\/name=/ { print "version/name=\"" new_ver "\""; next }
          { print }
        ' export_presets.cfg > export_presets.cfg.tmp && mv export_presets.cfg.tmp export_presets.cfg
        
        if ! grep -q "version/name=\"${VERSION_NUMBER}\"" export_presets.cfg; then
          echo "Error: Failed to update version/name in export_presets.cfg"
          exit 1
        fi
        
        # Bump version code (extract current code from first preset and increment)
        CURRENT_CODE=$(grep -m 1 "^version/code=" export_presets.cfg | sed 's#version/code=##')
        if [ -z "$CURRENT_CODE" ]; then
          echo "Error: Could not find version/code in export_presets.cfg"
          exit 1
        fi
        NEW_CODE=$((CURRENT_CODE + 1))
        
        # Update version/code for both presets using awk
        awk -v old_code="$CURRENT_CODE" -v new_code="$NEW_CODE" '
          /^version\/code=/ && $0 ~ ("version/code=" old_code) { print "version/code=" new_code; next }
          { print }
        ' export_presets.cfg > export_presets.cfg.tmp && mv export_presets.cfg.tmp export_presets.cfg
        
        if ! grep -q "version/code=${NEW_CODE}" export_presets.cfg; then
          echo "Error: Failed to update version/code in export_presets.cfg"
          exit 1
        fi
        
        # Verify the updates were successful
        VERSION_COUNT=$(grep -c "version/name=\"${VERSION_NUMBER}\"" export_presets.cfg)
        CODE_COUNT=$(grep -c "version/code=${NEW_CODE}" export_presets.cfg)
        
        if [ "$VERSION_COUNT" -ne 2 ]; then
          echo "Error: Expected 2 version/name updates, found ${VERSION_COUNT}"
          exit 1
        fi
        
        if [ "$CODE_COUNT" -ne 2 ]; then
          echo "Error: Expected 2 version/code updates, found ${CODE_COUNT}"
          exit 1
        fi
        
        echo "Updated version/name to ${VERSION_NUMBER} and version/code to ${NEW_CODE} for both presets"
        
        # Show the changes
        grep "version/" export_presets.cfg
    
    - name: Update project.godot with new version
      run: |
        VERSION_NUMBER="${{ steps.version.outputs.new_version }}"
        VERSION_NUMBER=${VERSION_NUMBER#v}  # Remove 'v' prefix
        
        # Update config/version in project.godot (using # as delimiter to avoid conflicts with /)
        if ! sed -i "s#^config/version=\"[^\"]*\"#config/version=\"${VERSION_NUMBER}\"#" project.godot; then
          echo "Error: Failed to update project.godot"
          exit 1
        fi
        
        # Verify the update was successful (using -F for literal matching)
        if ! grep -qF "config/version=\"${VERSION_NUMBER}\"" project.godot; then
          echo "Error: Version update verification failed in project.godot"
          echo "Expected: config/version=\"${VERSION_NUMBER}\""
          echo "Current content:"
          grep "config/version=" project.godot || echo "No config/version line found"
          exit 1
        fi
        
        echo "Updated project.godot config/version to ${VERSION_NUMBER}"
        
        # Show the change
        grep "config/version=" project.godot
    
    - name: Setup Godot
      uses: chickensoft-games/setup-godot@v1
      with:
        version: 4.3.0
        use-dotnet: false
        include-templates: true
    
    - name: Install Android Build Template
      run: |
        echo "Installing Android build template for widget builds..."
        
        # Debug: Show where templates are installed
        echo "Checking for Godot templates..."
        find ~/.local/share/godot -name "android_source.zip" 2>/dev/null || echo "No android_source.zip found in ~/.local/share/godot"
        
        # Run the install script
        chmod +x ./install_android_build_template.sh
        if ./install_android_build_template.sh; then
          echo "✓ Android build template installed successfully"
        else
          echo "⚠️ Failed to install Android build template automatically"
          echo "Widget APK build may fail"
          
          # Show template directory structure for debugging
          echo "Template directory contents:"
          ls -la ~/.local/share/godot/ 2>/dev/null || echo "No templates directory found"
          ls -la ~/.local/share/godot/export_templates/ 2>/dev/null || echo "No export_templates subdirectory"
        fi
    
    - name: Rebuild APKs with updated version
      run: |
        echo "Rebuilding Android APKs with updated version..."
        mkdir -p release
        
        # Build standard APK
        echo "Building standard APK..."
        godot --headless --export-debug "Android" release/YouGame.apk || { echo "Godot standard export failed"; exit 1; }
        
        # Verify the standard APK was created
        if [ -f release/YouGame.apk ]; then
          echo "Standard APK rebuilt successfully with new version!"
          ls -lh release/YouGame.apk
          
          # Rename APK to include version number
          VERSION="${{ steps.version.outputs.new_version }}"
          mv release/YouGame.apk "release/YouGame-${VERSION}.apk"
          echo "Renamed standard APK to YouGame-${VERSION}.apk"
        else
          echo "Error: Standard APK was not created"
          exit 1
        fi
        
        # Build widget APK - allow failure
        echo "Building widget-enabled APK..."
        if godot --headless --export-debug "Android Widget" release/YouGame-Widget.apk 2>&1; then
          # Verify the widget APK was created
          if [ -f release/YouGame-Widget.apk ]; then
            echo "Widget APK rebuilt successfully with new version!"
            ls -lh release/YouGame-Widget.apk
            
            # Rename APK to include version number
            VERSION="${{ steps.version.outputs.new_version }}"
            mv release/YouGame-Widget.apk "release/YouGame-Widget-${VERSION}.apk"
            echo "Renamed widget APK to YouGame-Widget-${VERSION}.apk"
            echo "WIDGET_BUILD_SUCCESS=true" >> $GITHUB_ENV
          else
            echo "⚠️ Widget APK build completed but file not found"
            echo "WIDGET_BUILD_SUCCESS=false" >> $GITHUB_ENV
          fi
        else
          echo "⚠️ Widget APK build failed - this may be due to missing Android build template"
          echo "Only the standard APK will be included in the release"
          echo "WIDGET_BUILD_SUCCESS=false" >> $GITHUB_ENV
        fi
        
        echo "Build process completed!"
        ls -lh release/
    
    - name: Commit version changes
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add export_presets.cfg project.godot
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Bump version to ${{ steps.version.outputs.new_version }}"
          git pull --rebase origin main || echo "Pull failed, will retry push"
          git push origin main || echo "Push failed - version bump may need manual intervention"
        fi
    
    - name: Generate Release Body
      id: release_body
      run: |
        VERSION="${{ steps.version.outputs.new_version }}"
        
        # Check if widget build was successful and generate appropriate release body
        if [ "$WIDGET_BUILD_SUCCESS" = "true" ]; then
          # Both APKs available
          cat > /tmp/release_body.txt <<EOF
        Automated release for YouGame
        
        Version: ${VERSION}
        
        ## Changes
        This release was automatically created from the latest merge to main.
        
        ## Download
        Two APK variants are available:
        
        - **YouGame-${VERSION}.apk** - Standard game APK (lighter, no widget)
        - **YouGame-Widget-${VERSION}.apk** - Game APK with home screen widget support
        
        ### Widget APK Features
        The widget-enabled APK includes a home screen widget that displays:
        - Last saved timestamp
        - Current game day
        - Player health
        - Torch count
        - Player position
        
        Choose the widget APK if you want to see your game status without opening the app!
        EOF
        else
          # Only standard APK available
          cat > /tmp/release_body.txt <<EOF
        Automated release for YouGame
        
        Version: ${VERSION}
        
        ## Changes
        This release was automatically created from the latest merge to main.
        
        ## Download
        Download the APK below to install on Android devices.
        
        - **YouGame-${VERSION}.apk** - Standard game APK
        
        **Note:** Widget-enabled APK build was not available for this release.
        EOF
        fi
        
        # Output for debugging
        echo "Generated release body:"
        cat /tmp/release_body.txt
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.new_version }}
        name: Release ${{ steps.version.outputs.new_version }}
        body_path: /tmp/release_body.txt
        files: |
          ./release/*.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
