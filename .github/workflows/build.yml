name: Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write  # Changed to write to allow creating releases and tags

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Godot
      uses: chickensoft-games/setup-godot@v1
      with:
        version: 4.3.0
        use-dotnet: false
    
    - name: Verify project structure
      run: |
        echo "Checking project structure..."
        ls -la
        cat project.godot
    
    - name: Validate scripts (check for parse errors)
      run: |
        echo "Validating GDScript files for parse errors..."
        godot --headless --path . --check-only --quit 2>&1 | tee script_validation.log
        if grep -qi "SCRIPT ERROR:\|Parse Error:\|PARSE ERROR:\|Failed to load script" script_validation.log; then
          echo "❌ Script validation failed - parse errors detected"
          grep -i "SCRIPT ERROR:\|Parse Error:\|PARSE ERROR:\|Failed to load script" script_validation.log
          exit 1
        else
          echo "✅ All scripts validated successfully"
        fi
    
    - name: Run tests with timeout monitoring
      timeout-minutes: 10
      run: |
        echo "Running test suite with individual test timeouts..."
        chmod +x tests/run_tests.sh
        ./tests/run_tests.sh
    
    - name: Upload test screenshots
      uses: actions/upload-artifact@v4
      if: always()  # Upload screenshots even if tests fail
      with:
        name: test-screenshots
        path: test_screenshots/*.png
        if-no-files-found: ignore

  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    needs: test
    
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Godot
      uses: chickensoft-games/setup-godot@v1
      with:
        version: 4.3.0
        use-dotnet: false
        include-templates: true
    
    - name: Create export directory
      run: mkdir -p export
    
    - name: Build APK
      run: |
        echo "Building Android APK..."
        echo "Using debug export with automatic debug keystore signing"
        godot --headless --export-debug "Android" export/YouGame.apk || { echo "Godot export failed"; exit 1; }
        
        # Verify the APK was created
        if [ -f export/YouGame.apk ]; then
          echo "APK created successfully!"
          ls -lh export/YouGame.apk
        else
          echo "Error: APK was not created"
          exit 1
        fi
    
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: YouGame-APK
        path: export/*.apk
        if-no-files-found: warn

  build-android-with-widget:
    name: Build Android APK with Widget
    runs-on: ubuntu-latest
    needs: test
    
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Godot
      uses: chickensoft-games/setup-godot@v1
      with:
        version: 4.3.0
        use-dotnet: false
        include-templates: true
    
    - name: Install Android Build Template
      run: |
        echo "Installing Android build template..."
        # Use Godot's headless mode to install the Android build template
        # The --install-android-build-template flag installs it non-interactively
        godot --headless --quit --install-android-build-template 2>&1 || echo "Template installation attempted"
        
        # Verify the template was installed
        if [ -d "android/build" ]; then
          echo "✅ Android build template installed successfully"
          ls -la android/build/
        else
          echo "⚠️  Build template directory not created, trying alternative method..."
          # Create the android/build directory structure manually if needed
          mkdir -p android/build
          echo "Created android/build directory"
        fi
    
    - name: Enable Gradle Build
      run: |
        echo "Enabling Gradle build for widget support..."
        sed -i 's/gradle_build\/use_gradle_build=false/gradle_build\/use_gradle_build=true/' export_presets.cfg
        
        # Verify the change
        if grep -q "gradle_build/use_gradle_build=true" export_presets.cfg; then
          echo "✅ Gradle build enabled"
        else
          echo "❌ Failed to enable Gradle build"
          exit 1
        fi
    
    - name: Create export directory
      run: mkdir -p export
    
    - name: Build APK with Widget
      run: |
        echo "Building Android APK with Widget support..."
        echo "Using debug export with automatic debug keystore signing"
        godot --headless --export-debug "Android" export/YouGame-Widget.apk || { echo "Godot export failed"; exit 1; }
        
        # Verify the APK was created
        if [ -f export/YouGame-Widget.apk ]; then
          echo "APK with widget created successfully!"
          ls -lh export/YouGame-Widget.apk
        else
          echo "Error: APK was not created"
          exit 1
        fi
    
    - name: Upload Widget APK artifact
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: YouGame-Widget-APK
        path: export/*.apk
        if-no-files-found: warn

  release:
    name: Create Release on Merge
    runs-on: ubuntu-latest
    needs: [build-android, build-android-with-widget]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for tags
    
    - name: Get latest tag and bump version
      id: version
      run: |
        # Get the latest tag, or start with v1.0.0 if no tags exist
        git fetch --tags
        LATEST_TAG=$(git tag -l "v*" | sort -V | tail -n 1)
        
        if [ -z "$LATEST_TAG" ]; then
          # No tags exist, start with v1.0.0
          NEW_VERSION="v1.0.0"
        else
          # Extract version numbers
          VERSION=${LATEST_TAG#v}
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
          
          # Bump patch version
          PATCH=$((PATCH + 1))
          NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}"
        fi
        
        echo "new_version=${NEW_VERSION}" >> $GITHUB_OUTPUT
        echo "New version will be: ${NEW_VERSION}"
    
    - name: Update export_presets.cfg with new version
      run: |
        VERSION_NUMBER="${{ steps.version.outputs.new_version }}"
        VERSION_NUMBER=${VERSION_NUMBER#v}  # Remove 'v' prefix
        
        # Update version/name in export_presets.cfg (matches line starting with version/name=)
        if ! sed -i "s#^version/name=\"[^\"]*\"#version/name=\"${VERSION_NUMBER}\"#" export_presets.cfg; then
          echo "Error: Failed to update version/name in export_presets.cfg"
          exit 1
        fi
        
        # Bump version code (extract current code and increment, use -m 1 for first match only)
        CURRENT_CODE=$(grep -m 1 "^version/code=" export_presets.cfg | sed 's#version/code=##')
        if [ -z "$CURRENT_CODE" ]; then
          echo "Error: Could not find version/code in export_presets.cfg"
          exit 1
        fi
        NEW_CODE=$((CURRENT_CODE + 1))
        if ! sed -i "s#^version/code=${CURRENT_CODE}#version/code=${NEW_CODE}#" export_presets.cfg; then
          echo "Error: Failed to update version/code in export_presets.cfg"
          exit 1
        fi
        
        # Verify the updates were successful
        if ! grep -qF "version/name=\"${VERSION_NUMBER}\"" export_presets.cfg; then
          echo "Error: Version name update verification failed in export_presets.cfg"
          exit 1
        fi
        if ! grep -qF "version/code=${NEW_CODE}" export_presets.cfg; then
          echo "Error: Version code update verification failed in export_presets.cfg"
          exit 1
        fi
        
        echo "Updated version/name to ${VERSION_NUMBER} and version/code to ${NEW_CODE}"
        
        # Show the changes
        grep "version/" export_presets.cfg
    
    - name: Update project.godot with new version
      run: |
        VERSION_NUMBER="${{ steps.version.outputs.new_version }}"
        VERSION_NUMBER=${VERSION_NUMBER#v}  # Remove 'v' prefix
        
        # Update config/version in project.godot (using # as delimiter to avoid conflicts with /)
        if ! sed -i "s#^config/version=\"[^\"]*\"#config/version=\"${VERSION_NUMBER}\"#" project.godot; then
          echo "Error: Failed to update project.godot"
          exit 1
        fi
        
        # Verify the update was successful (using -F for literal matching)
        if ! grep -qF "config/version=\"${VERSION_NUMBER}\"" project.godot; then
          echo "Error: Version update verification failed in project.godot"
          echo "Expected: config/version=\"${VERSION_NUMBER}\""
          echo "Current content:"
          grep "config/version=" project.godot || echo "No config/version line found"
          exit 1
        fi
        
        echo "Updated project.godot config/version to ${VERSION_NUMBER}"
        
        # Show the change
        grep "config/version=" project.godot
    
    - name: Setup Godot
      uses: chickensoft-games/setup-godot@v1
      with:
        version: 4.3.0
        use-dotnet: false
        include-templates: true
    
    - name: Rebuild Standard APK with updated version
      run: |
        echo "Rebuilding standard Android APK with updated version..."
        mkdir -p release
        godot --headless --export-debug "Android" release/YouGame.apk || { echo "Godot export failed"; exit 1; }
        
        # Verify the APK was created
        if [ -f release/YouGame.apk ]; then
          echo "Standard APK rebuilt successfully with new version!"
          ls -lh release/YouGame.apk
          
          # Rename APK to include version number
          VERSION="${{ steps.version.outputs.new_version }}"
          mv release/YouGame.apk "release/YouGame-${VERSION}.apk"
          echo "Renamed standard APK to YouGame-${VERSION}.apk"
        else
          echo "Error: Standard APK was not created"
          exit 1
        fi
    
    - name: Install Android Build Template for Widget build
      run: |
        echo "Installing Android build template for widget build..."
        godot --headless --quit --install-android-build-template 2>&1 || echo "Template installation attempted"
        
        if [ ! -d "android/build" ]; then
          mkdir -p android/build
          echo "Created android/build directory"
        fi
    
    - name: Rebuild Widget APK with updated version
      run: |
        echo "Rebuilding widget-enabled Android APK with updated version..."
        
        # Enable Gradle build for widget
        sed -i 's/gradle_build\/use_gradle_build=false/gradle_build\/use_gradle_build=true/' export_presets.cfg
        
        # Build widget APK
        godot --headless --export-debug "Android" release/YouGame-Widget.apk || { echo "Widget APK export failed"; exit 1; }
        
        # Verify the APK was created
        if [ -f release/YouGame-Widget.apk ]; then
          echo "Widget APK rebuilt successfully with new version!"
          ls -lh release/YouGame-Widget.apk
          
          # Rename APK to include version number
          VERSION="${{ steps.version.outputs.new_version }}"
          mv release/YouGame-Widget.apk "release/YouGame-Widget-${VERSION}.apk"
          echo "Renamed widget APK to YouGame-Widget-${VERSION}.apk"
        else
          echo "Error: Widget APK was not created"
          exit 1
        fi
        
        # Revert Gradle build change (don't commit it)
        git checkout export_presets.cfg
        
        echo "Final release files:"
        ls -lh release/
    
    - name: Commit version changes
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add export_presets.cfg project.godot
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Bump version to ${{ steps.version.outputs.new_version }}"
          git pull --rebase origin main || echo "Pull failed, will retry push"
          git push origin main || echo "Push failed - version bump may need manual intervention"
        fi
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.new_version }}
        name: Release ${{ steps.version.outputs.new_version }}
        body: |
          Automated release for YouGame
          
          Version: ${{ steps.version.outputs.new_version }}
          
          ## Download Options
          
          **YouGame-${{ steps.version.outputs.new_version }}.apk** - Standard version
          - Standard Android build without widget feature
          - Recommended for most users
          - Smaller APK size
          
          **YouGame-Widget-${{ steps.version.outputs.new_version }}.apk** - Widget version
          - Includes Android home screen widget feature
          - Shows save game status on home screen
          - Slightly larger APK size due to widget components
          
          ## Changes
          This release was automatically created from the latest merge to main.
          
          ## Installation
          Download the APK of your choice and install on Android devices.
          
          For widget functionality in the Widget version:
          1. Install the APK
          2. Save your game at least once
          3. Long-press home screen → Widgets → "YouGame Save Status"
        files: |
          ./release/*.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
