name: Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write  # Changed to write to allow creating releases and tags

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Godot
      uses: chickensoft-games/setup-godot@v1
      with:
        version: 4.3.0
        use-dotnet: false
    
    - name: Verify project structure
      run: |
        echo "Checking project structure..."
        ls -la
        cat project.godot
    
    - name: Run tests with timeout monitoring
      timeout-minutes: 10
      run: |
        echo "Running test suite with individual test timeouts..."
        chmod +x tests/run_tests.sh
        ./tests/run_tests.sh

  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    needs: test
    
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Godot
      uses: chickensoft-games/setup-godot@v1
      with:
        version: 4.3.0
        use-dotnet: false
        include-templates: true
    
    - name: Create export directory
      run: mkdir -p export
    
    - name: Build APK
      run: |
        echo "Building Android APK..."
        echo "Using debug export with automatic debug keystore signing"
        godot --headless --export-debug "Android" export/YouGame.apk || { echo "Godot export failed"; exit 1; }
        
        # Verify the APK was created
        if [ -f export/YouGame.apk ]; then
          echo "APK created successfully!"
          ls -lh export/YouGame.apk
        else
          echo "Error: APK was not created"
          exit 1
        fi
    
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: YouGame-APK
        path: export/*.apk
        if-no-files-found: warn

  release:
    name: Create Release on Merge
    runs-on: ubuntu-latest
    needs: build-android
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for tags
    
    - name: Get latest tag and bump version
      id: version
      run: |
        # Get the latest tag, or start with v1.0.0 if no tags exist
        git fetch --tags
        LATEST_TAG=$(git tag -l "v*" | sort -V | tail -n 1)
        
        if [ -z "$LATEST_TAG" ]; then
          # No tags exist, start with v1.0.0
          NEW_VERSION="v1.0.0"
        else
          # Extract version numbers
          VERSION=${LATEST_TAG#v}
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
          
          # Bump patch version
          PATCH=$((PATCH + 1))
          NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}"
        fi
        
        echo "new_version=${NEW_VERSION}" >> $GITHUB_OUTPUT
        echo "New version will be: ${NEW_VERSION}"
    
    - name: Update export_presets.cfg with new version
      run: |
        VERSION_NUMBER="${{ steps.version.outputs.new_version }}"
        VERSION_NUMBER=${VERSION_NUMBER#v}  # Remove 'v' prefix
        
        # Update version/name in export_presets.cfg (matches line starting with version/name=)
        sed -i "s/^version\/name=\"[^\"]*\"/version\/name=\"${VERSION_NUMBER}\"/" export_presets.cfg
        
        # Bump version code (extract current code and increment, use -m 1 for first match only)
        CURRENT_CODE=$(grep -m 1 "^version/code=" export_presets.cfg | sed 's/version\/code=//')
        NEW_CODE=$((CURRENT_CODE + 1))
        sed -i "s/^version\/code=${CURRENT_CODE}/version\/code=${NEW_CODE}/" export_presets.cfg
        
        echo "Updated version/name to ${VERSION_NUMBER} and version/code to ${NEW_CODE}"
        
        # Show the changes
        grep "version/" export_presets.cfg
    
    - name: Setup Godot
      uses: chickensoft-games/setup-godot@v1
      with:
        version: 4.3.0
        use-dotnet: false
        include-templates: true
    
    - name: Rebuild APK with updated version
      run: |
        echo "Rebuilding Android APK with updated version..."
        mkdir -p release
        godot --headless --export-debug "Android" release/YouGame.apk || { echo "Godot export failed"; exit 1; }
        
        # Verify the APK was created
        if [ -f release/YouGame.apk ]; then
          echo "APK rebuilt successfully with new version!"
          ls -lh release/YouGame.apk
        else
          echo "Error: APK was not created"
          exit 1
        fi
    
    - name: Commit version changes
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add export_presets.cfg
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Bump version to ${{ steps.version.outputs.new_version }}"
          git pull --rebase origin main || echo "Pull failed, will retry push"
          git push origin main || echo "Push failed - version bump may need manual intervention"
        fi
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.new_version }}
        name: Release ${{ steps.version.outputs.new_version }}
        body: |
          Automated release for YouGame
          
          Version: ${{ steps.version.outputs.new_version }}
          
          ## Changes
          This release was automatically created from the latest merge to main.
          
          ## Download
          Download the APK below to install on Android devices.
        files: |
          ./release/*.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
